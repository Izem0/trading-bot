name: Deploy to EC2 using ssh

on:
  push:
    branches:
      - main

env:
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  EC2_HOST: ${{ secrets.EC2_HOST }}
  WORKDIR: ${{ secrets.SSH_PRIVATE_KEY }}
  EC2_USER: ${{ secrets.EC2_USER }}
  DOTENV: ${{ secrets.DOTENV }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create known_hosts file
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${EC2_HOST} >> ~/.ssh/known_hosts

      - name: Write SSH key to file
        run: |
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/private_key
          chmod 600 ~/.ssh/private_key

      - name: Upload .env to EC2
        run: |
          echo ${DOTENV} >> .env
          echo DEBUG=0 >> .env
          scp -i ~/.ssh/private_key .env ${EC2_USER}@${EC2_HOST}:${WORKDIR}

      - name: Upload strategies.py to EC2
        run: |
          echo "${STRATEGIES}" > strategies.py
          scp -i ~/.ssh/private_key strategies.py ${EC2_USER}@${EC2_HOST}:${WORKDIR}

      - name: Deploy code to EC2
        run: |
          ssh -i ~/.ssh/private_key ${EC2_USER}@${EC2_HOST} <<'EOF'
          cd ${WORKDIR}
          git reset --hard HEAD
          git pull origin main
          source venv/bin/activate
          pip install -r requirements.txt
